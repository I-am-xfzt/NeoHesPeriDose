<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D盘文件浏览器</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: #4a6bdf;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        h1 {
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .breadcrumb {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            background: #f0f4ff;
            border-bottom: 1px solid #ddd;
            font-size: 14px;
            flex-wrap: wrap;
        }
        
        .breadcrumb a {
            color: #4a6bdf;
            text-decoration: none;
            cursor: pointer;
        }
        
        .breadcrumb a:hover {
            text-decoration: underline;
        }
        
        .breadcrumb span {
            margin: 0 8px;
            color: #888;
        }
        
        .main-content {
            display: flex;
            height: calc(100vh - 200px);
        }
        
        .file-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            border-right: 1px solid #eee;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .file-item:hover {
            background: #f8f9ff;
        }
        
        .file-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            color: #4a6bdf;
        }
        
        .file-info {
            flex: 1;
        }
        
        .file-name {
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .file-details {
            font-size: 12px;
            color: #777;
            display: flex;
            gap: 15px;
        }
        
        .preview-pane {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #fafbff;
        }
        
        .preview-content {
            width: 100%;
            max-height: 400px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: auto;
        }
        
        .preview-content img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .preview-content embed {
            width: 100%;
            height: 400px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .preview-placeholder {
            color: #888;
            text-align: center;
        }
        
        .preview-placeholder i {
            font-size: 64px;
            margin-bottom: 15px;
            color: #ccd0e6;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        button {
            padding: 10px 20px;
            background: #4a6bdf;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }
        
        button:hover {
            background: #3a5bc7;
        }
        
        button.secondary {
            background: #6c757d;
        }
        
        button.secondary:hover {
            background: #5a6268;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            flex-direction: column;
            gap: 15px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4a6bdf;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: #ffecec;
            color: #d86161;
            padding: 15px;
            border-radius: 6px;
            margin: 15px;
            border-left: 4px solid #d86161;
        }
        
        .hidden {
            display: none;
        }
        
        .text-preview {
            width: 100%;
            height: 400px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            overflow: auto;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
                height: auto;
            }
            
            .file-list {
                border-right: none;
                border-bottom: 1px solid #eee;
                max-height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-hard-drive"></i> D盘文件浏览器</h1>
            <div class="server-status">服务器: http://localhost:4000</div>
        </header>
        
        <div class="breadcrumb">
            <a class="path-link" data-path="">D:</a>
            <span>/</span>
        </div>
        
        <div id="error-message" class="error-message hidden"></div>
        
        <div class="main-content">
            <div class="file-list" id="file-list">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>正在加载文件列表...</p>
                </div>
            </div>
            
            <div class="preview-pane">
                <div class="preview-content" id="preview-content">
                    <div class="preview-placeholder">
                        <i class="far fa-file-alt"></i>
                        <p>选择文件进行预览</p>
                    </div>
                </div>
                <div class="action-buttons">
                    <button id="download-btn" class="hidden">下载</button>
                    <button id="open-btn" class="hidden">打开</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API基础URL
        const API_BASE = 'http://localhost:4000/api';
        let currentPath = '';
        let currentFile = null;
        
        // DOM元素
        const fileListEl = document.getElementById('file-list');
        const breadcrumbEl = document.querySelector('.breadcrumb');
        const previewContentEl = document.getElementById('preview-content');
        const downloadBtn = document.getElementById('download-btn');
        const openBtn = document.getElementById('open-btn');
        const errorMessageEl = document.getElementById('error-message');
        
        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            loadDirectory('3D_Models');
            setupEventListeners();
        });
        
        // 设置事件监听器
        function setupEventListeners() {
            // 下载按钮事件
            downloadBtn.addEventListener('click', downloadCurrentFile);
            
            // 打开按钮事件
            openBtn.addEventListener('click', openCurrentFile);
            
            // 面包屑导航事件委托
            breadcrumbEl.addEventListener('click', (e) => {
                if (e.target.classList.contains('path-link')) {
                    const path = e.target.getAttribute('data-path');
                    loadDirectory(path);
                }
            });
        }
        
        // 加载目录内容
        async function loadDirectory(path) {
            showLoading();
            hideError();
            resetPreview();
            
            try {
                const response = await fetch(`${API_BASE}/files?path=${encodeURIComponent(path)}`);
                const data = await response.json();
                
                if (data.success) {
                    currentPath = path;
                    renderBreadcrumb(path);
                    renderFileList(data.data);
                } else {
                    showError(data.message || '加载目录失败');
                }
            } catch (error) {
                showError(`网络错误: ${error.message}`);
                console.error('API请求失败:', error);
            }
        }
        
        // 渲染面包屑导航
        function renderBreadcrumb(path) {
            const parts = path.split('/').filter(part => part !== '');
            let breadcrumbHtml = `<a class="path-link" data-path="">D:</a>`;
            let currentPath = '';
            
            for (let i = 0; i < parts.length; i++) {
                currentPath += parts[i] + '/';
                breadcrumbHtml += `<span>/</span><a class="path-link" data-path="${currentPath}">${parts[i]}</a>`;
            }
            
            breadcrumbEl.innerHTML = breadcrumbHtml;
        }
        
        // 渲染文件列表
        function renderFileList(files) {
            if (files.length === 0) {
                fileListEl.innerHTML = '<div class="file-item">此文件夹为空</div>';
                return;
            }
            
            let html = '';
            
            files.forEach(file => {
                const icon = getFileIcon(file);
                
                html += `
                    <div class="file-item" data-type="${file.type}" data-path="${file.path}">
                        <div class="file-icon">
                            <i class="${icon}"></i>
                        </div>
                        <div class="file-info">
                            <div class="file-name">${file.name}</div>
                            <div class="file-details">
                                <span>${file.type === 'directory' ? '文件夹' : `大小: ${formatFileSize(file.size)}`}</span>
                                <span>修改时间: ${formatDate(file.modified)}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            fileListEl.innerHTML = html;
            
            // 添加文件项点击事件
            const fileItems = fileListEl.querySelectorAll('.file-item');
            fileItems.forEach(item => {
                item.addEventListener('click', () => {
                    const type = item.getAttribute('data-type');
                    const path = item.getAttribute('data-path');
                    
                    if (type === 'directory') {
                        loadDirectory(path);
                    } else {
                        currentFile = path;
                        previewFile(path);
                    }
                });
            });
        }
        
        // 预览文件
        async function previewFile(filePath) {
            showLoadingPreview();
            console.log(filePath);
            
            // 根据文件扩展名确定预览方式
            const extension = filePath.split('.').pop().toLowerCase();
            const previewUrl = `${API_BASE}/binary-file?path=${encodeURIComponent(filePath)}`;
            
            // 显示操作按钮
            downloadBtn.classList.remove('hidden');
            openBtn.classList.remove('hidden');
            
            try {
                // 根据文件类型进行预览
                if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(extension)) {
                    // 图片文件 - 直接使用img标签
                    previewContentEl.innerHTML = `<img src="${previewUrl}" alt="预览">`;
                } else if (extension === 'pdf') {
                    // PDF文件 - 使用embed标签
                    previewContentEl.innerHTML = `
                        <embed src="${previewUrl}#toolbar=1&view=FitH" type="application/pdf" width="100%" height="400px">
                    `;
                } else if (['txt', 'json', 'js', 'css', 'html', 'xml', 'md'].includes(extension)) {
                    // 文本文件 - 获取内容并显示
                    const response = await fetch(previewUrl);
                    const text = await response.text();
                    previewContentEl.innerHTML = `
                        <div class="text-preview">${escapeHtml(text)}</div>
                    `;
                } else if (extension === 'glb') {
                    // 3D模型文件 - 提示需要专用预览
                    previewContentEl.innerHTML = `
                        <div class="preview-placeholder">
                            <i class="fas fa-cube"></i>
                            <p>3D模型文件</p>
                            <p>需要专用预览器查看此文件</p>
                            <p><a href="${previewUrl}" target="_blank">下载文件</a></p>
                        </div>
                    `;
                } else {
                    // 其他文件类型 - 显示下载链接
                    previewContentEl.innerHTML = `
                        <div class="preview-placeholder">
                            <i class="far fa-file-alt"></i>
                            <p>无法预览此文件类型</p>
                            <p><a href="${previewUrl}" target="_blank">下载文件</a></p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('预览文件失败:', error);
                previewContentEl.innerHTML = `
                    <div class="preview-placeholder">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>预览文件时出错</p>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        // 下载当前文件
        function downloadCurrentFile() {
            if (!currentFile) return;
            
            const fileUrl = `${API_BASE}/binary-file?path=${encodeURIComponent(currentFile)}`;
            
            // 创建一个隐藏的a标签用于下载
            const a = document.createElement('a');
            a.href = fileUrl;
            a.download = currentFile.split('/').pop();
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        
        // 打开当前文件
        function openCurrentFile() {
            if (!currentFile) return;
            
            const fileUrl = `${API_BASE}/binary-file?path=${encodeURIComponent(currentFile)}`;
            window.open(fileUrl, '_blank');
        }
        
        // 显示加载状态
        function showLoading() {
            fileListEl.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>正在加载文件列表...</p>
                </div>
            `;
        }
        
        // 显示预览加载状态
        function showLoadingPreview() {
            previewContentEl.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>正在加载预览...</p>
                </div>
            `;
        }
        
        // 重置预览区域
        function resetPreview() {
            previewContentEl.innerHTML = `
                <div class="preview-placeholder">
                    <i class="far fa-file-alt"></i>
                    <p>选择文件进行预览</p>
                </div>
            `;
            downloadBtn.classList.add('hidden');
            openBtn.classList.add('hidden');
            currentFile = null;
        }
        
        // 显示错误信息
        function showError(message) {
            errorMessageEl.textContent = message;
            errorMessageEl.classList.remove('hidden');
        }
        
        // 隐藏错误信息
        function hideError() {
            errorMessageEl.classList.add('hidden');
        }
        
        // 获取文件图标
        function getFileIcon(file) {
            if (file.type === 'directory') {
                return 'fas fa-folder';
            }
            
            switch (file.extension) {
                case '.jpg':
                case '.jpeg':
                case '.png':
                case '.gif':
                case '.webp':
                    return 'fas fa-image';
                case '.pdf':
                    return 'fas fa-file-pdf';
                case '.doc':
                case '.docx':
                    return 'fas fa-file-word';
                case '.xls':
                case '.xlsx':
                    return 'fas fa-file-excel';
                case '.mp4':
                case '.avi':
                case '.mov':
                    return 'fas fa-file-video';
                case '.mp3':
                case '.wav':
                    return 'fas fa-file-audio';
                case '.glb':
                    return 'fas fa-cube';
                case '.txt':
                case '.json':
                case '.js':
                case '.css':
                case '.html':
                case '.xml':
                case '.md':
                    return 'fas fa-file-code';
                default:
                    return 'fas fa-file';
            }
        }
        
        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // 格式化日期
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }
        
        // HTML转义函数
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>